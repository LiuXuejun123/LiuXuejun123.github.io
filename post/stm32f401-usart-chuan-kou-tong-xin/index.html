
<!DOCTYPE html>
<html lang="zh-CN">
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
<meta HTTP-EQUIV="pragma" CONTENT="no-cache"> 
<meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"> 
<meta HTTP-EQUIV="expires" CONTENT="0"> 
<title>STM32F401 USART 串口通信 | Liu Xuejun&#39;s Blog</title>	

<link rel="stylesheet" href="https://liuxuejun123.github.io//styles/main.css">
<script type="text/javascript">
function getCSS()
{
        datetoday = new Date();
        timenow=datetoday.getTime();
        datetoday.setTime(timenow);
        thehour = datetoday.getHours();

        if (thehour<6)

            display = "https://liuxuejun123.github.io//media/css/night.css";

       else if (thehour>20)

            display = "https://liuxuejun123.github.io//media/css/night.css";   

        else if (thehour>6)
           
            display = "https://liuxuejun123.github.io//media/css/day.css";

        else if (thehour<20)

            display = "https://liuxuejun123.github.io//media/css/day.css";
      

var css = '<';
        css+='link rel="stylesheet" href='+display+' \/';
        css+='>';
        document.write(css);
}
</script>
<link href="https://fonts.googleapis.com/css?family=Dancing+Script|Liu+Jian+Mao+Cao&display=swap" rel="stylesheet">
<link href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css" rel="stylesheet" />
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<script type='text/javascript' src='https://liuxuejun123.github.io//media/scripts/script.js'></script>
<link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet" />
  <script src="https://cdn.bootcss.com/wow/1.1.2/wow.min.js"></script>
  <script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>wow=new WOW({boxClass:'wow',animateClass:'animated',offset:0,mobile:true,live:true});wow.init();</script>

<script type="text/javascript">
window.onload=getCSS();
</script>


 	
</head>
<body class="post-template-default single single-post postid-70 single-format-standard">
    <div id="wrapper">
        
			
		<header id="header" class="site-header" 
		
		>
			<div class="site-branding">
									<h1 class="site-title"><a href="https://liuxuejun123.github.io/" rel="home">Liu Xuejun&#39;s Blog</a></h1>
										
					<h2 class="site-description">念念不忘，必有回响</h2>
										
							</div>
			<nav id="nav-wrapper">
				<div class="container">
					<div class="nav-toggle">
						<div class="bars">
							<div class="bar"></div>
							<div class="bar"></div>
							<div class="bar"></div>
						</div>
					</div>
					<div class="clear"></div>
					<ul id="" class="dove">
		 
     			
<li>
	 
	<a  href="/"> 首页</a></li>
	
    
     			
<li>
	 
	<a  href="/archives"> 归档</a></li>
	
    
     			
<li>
	 
	<a  href="/tags"> 标签</a></li>
	
    
     			
<li>
	 
	<a  href="/post/about"> 关于</a></li>
	
    

</ul>
</li>		
		
</ul>				</div>
			</nav>
						<div class="jingge">


    

    

    

    

    

    

    

    

    

    

    

    
        </header>

		<div id="content" class="container">
			<div class="row">
	<div class="col-md-8 site-main">
				
<article id="post-70" class="post-70 post type-post status-publish format-standard hentry category-5 tag-10 tag-9 tag-11">

	
	                      
		<div class="entry-content">
			<h1 class="wow swing entry-title">STM32F401 USART 串口通信</h1>
<div class="entry-meta">
<div class="wow bounce">
	<i class="iconfont icon-rili"> <time class="lately-a" datetime="2020-04-13 16:49:43" itemprop="datePublished" pubdate="">2020-04-13</time></i>
	          </div>
			
</span>
													 
		</div>
                  
			<div class="wow slideInLeft entry-summary song">
				<h2 id="1functional-requirement">1.functional requirement</h2>
<ol>
<li>
<p>Create function for send byte packet(array) via USART. In this function you need:<br>
a. Set output array counter variable equal numbers of bytes for send;<br>
b. Enable interrupt on Transmit buffer empty event;</p>
</li>
<li>
<p>In the USART Interrupt Handler on TXE flag send next byte until end, on the end disable interrupt on TXE;</p>
</li>
<li>
<p>On pressing button, launch send function (which created in step 1) and send some array;</p>
</li>
<li>
<p>In the USART Interrupt Handler on RXNE flag read byte and turn on/off LED, if it values equal to you variant.</p>
</li>
</ol>
<h2 id="2imliementation-process">2.Imliementation process</h2>
<figure data-type="image" tabindex="1"><img src="https://liuxuejun123.github.io//post-images/1586767962203.PNG" alt="" loading="lazy"></figure>
<h3 id="i">I</h3>
<p>The serial port of urasrt2, PA2 is TX, PA3 is RX .Set PA2 PA3 to alternate function mode through MODER register, set to usart2 function through AFR register</p>
<p><img src="https://liuxuejun123.github.io//post-images/1586767970236.PNG" alt="" loading="lazy">!</p>
<h3 id="ii">II</h3>
<p>Through USART block diagram</p>
<h4 id="baud-rate-registerusart_brr">Baud rate register(USART_BRR)</h4>
<figure data-type="image" tabindex="2"><img src="https://liuxuejun123.github.io//post-images/1586768017916.PNG" alt="" loading="lazy"></figure>
<p>Used to divide the clock to get the required baud rate.</p>
<p>The baud rate register includes two parts defined: DIV_Mantissa (integer part) and DIV_Fraction (decimal part).</p>
<h4 id="status-register-sr">Status register (SR)</h4>
<figure data-type="image" tabindex="3"><img src="https://liuxuejun123.github.io//post-images/1586768026986.PNG" alt="" loading="lazy"></figure>
<p>The status register is suitable for detecting the state of the serial port at this time. The states it can detect are: send register empty bit, send complete bit, read data register non-empty bit, detected main line idle bit, overload error, etc.</p>
<p>Here we mainly focus on two bits: RXNE and TC (bits 5 and 6).</p>
<h5 id="bit-6-tc-transmission-complete">Bit 6 TC: Transmission complete</h5>
<p>This bit is set by hardware if the transmission of a frame containing data is complete and if<br>
TXE is set. An interrupt is generated if TCIE=1 in the USART_CR1 register. It is cleared by<br>
a software sequence (a read from the USART_SR register followed by a write to the<br>
USART_DR register). The TC bit can also be cleared by writing a '0' to it. This clearing<br>
sequence is recommended only for multibuffer communication.<br>
0: Transmission is not complete<br>
1: Transmission is complete</p>
<h5 id="bit-5-rxne-read-data-register-not-empty">Bit 5 RXNE: Read data register not empty</h5>
<p>This bit is set by hardware when the content of the RDR shift register has been transferred<br>
to the USART_DR register. An interrupt is generated if RXNEIE=1 in the USART_CR1<br>
register. It is cleared by a read to the USART_DR register. The RXNE flag can also be<br>
cleared by writing a zero to it. This clearing sequence is recommended only for multibuffer<br>
communication.<br>
0: Data is not received<br>
1: Received data is ready to be read.</p>
<h4 id="data-register-usart_dr">Data register (USART_DR)</h4>
<p>USART_DR actually contains two registers, one dedicated to TDR for sending and one dedicated to RDR for receiving. When sending data, writing data to USART_DR will be automatically stored in TDR; when reading data, reading data from USART_DR will automatically extract RDR data.</p>
<p>Serial communication transmits one bit at a time, so the TDR and RDR registers are between the system bus and the shift register; the TDR content is transferred to the transmit shift register when sending data, and the receive is when receiving data Each bit that arrives is sequentially stored in the receive shift register and then transferred to the RDR.</p>
<h4 id="control-register-1-usart_cr1">Control register 1 (USART_CR1)</h4>
<figure data-type="image" tabindex="4"><img src="https://liuxuejun123.github.io//post-images/1586768045079.PNG" alt="" loading="lazy"></figure>
<p>The control register is mainly used to set USART enable, check control enable, check selection (odd parity even check), PE interrupt enable, send buffer empty interrupt enable, send complete interrupt enable, receive buffer is not empty Enable, send enable, receive enable, word length, etc.</p>
<h3 id="iii-general-steps-of-serial-port-operation">III General steps of serial port operation</h3>
<p>1.GPIO clock enable, serial port clock enable<br>
2.Port mode setting under GPIO peripheral function<br>
3.Serial port parameter initialization<br>
4.Turn on interrupt and initialize NVIC</p>
<h2 id="code">Code</h2>
<pre><code class="language-c">#include &quot;stm32f4xx.h&quot;
#include &quot;stm32f4xx_hal_gpio.h&quot;
#include &quot;stm32f4xx_hal_rcc.h&quot;
#include &lt;stdio.h&gt;
//define busses prescalers
#define AHB_PRE 1
#define APB1_PRE 2
#define APB2_PRE 1
#define SysTickClk 10000
//calculate peripheral frequencies
#define SYSCLK 84000000
#define AHB SYSCLK/AHB_PRE
#define APB1 AHB/APB1_PRE
#define APB1_TIM APB1*2
#define APB2 AHB/APB2_PRE
#define APB2_TIM APB2*1
#define SysTicks AHB/SysTickClk

//usart
#define USART_BAUDRATE 19200
#define BUFFER_LENGTH 1000
uint16_t buffer_size=0,current_send_byte;
uint8_t buffer[BUFFER_LENGTH];

void clock_set()
{
FLASH-&gt;ACR|=FLASH_ACR_PRFTEN;
FLASH-&gt;ACR|=FLASH_ACR_LATENCY_2WS;//FLASH PREFETCH
RCC-&gt;CFGR&amp;=~RCC_CFGR_HPRE_Msk;
RCC-&gt;CFGR|=RCC_CFGR_HPRE_DIV1;
RCC-&gt;CFGR&amp;=~RCC_CFGR_PPRE1_Msk;
RCC-&gt;CFGR|=RCC_CFGR_PPRE1_DIV2;
RCC-&gt;CFGR&amp;=~RCC_CFGR_PPRE2_Msk;
RCC-&gt;CFGR|=RCC_CFGR_PPRE2_DIV1;//set AHB APB1 APB2
RCC-&gt;PLLCFGR&amp;=~RCC_PLLCFGR_PLLM_Msk;
RCC-&gt;PLLCFGR|=8&lt;&lt;RCC_PLLCFGR_PLLM_Pos;
RCC-&gt;PLLCFGR&amp;=~RCC_PLLCFGR_PLLN_Msk;
RCC-&gt;PLLCFGR|=84&lt;&lt;RCC_PLLCFGR_PLLN_Pos;
RCC-&gt;PLLCFGR&amp;=~RCC_PLLCFGR_PLLP_Msk; //SET PLLM PLLN PLLP
RCC-&gt;CR|=RCC_CR_PLLON;//OPEN PLL
while((RCC-&gt;CR&amp;RCC_CR_PLLRDY)==0)//WAIT PLL START
{}
RCC-&gt;CFGR&amp;=(uint32_t)((uint32_t)~(RCC_CFGR_SW));
RCC-&gt;CFGR|=RCC_CFGR_SW_PLL;
while((RCC-&gt;CFGR&amp;RCC_CFGR_SWS)!=RCC_CFGR_SWS_PLL)
{}
}

void usart2_Init(uint32_t baud)
{
RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOAEN|
	              RCC_AHB1ENR_GPIOBEN;//open clock
GPIOA-&gt;MODER =0x000000A0;//pa2 pa3 alternate function mode 
GPIOA-&gt;AFR[0]=0x00007700;//
GPIOB-&gt;MODER=0x00005555;//GPIOB
RCC-&gt;APB1ENR |= RCC_APB1ENR_USART2EN;//usart2 enable
USART2-&gt;BRR = APB1/baud;//Baud rate
USART2-&gt;CR1 = USART_CR1_UE|//usart2 enable
	            USART_CR1_TE|//
	            USART_CR1_RE|//Send and receive enable
	            USART_CR1_RXNEIE;//Interrupt enable
NVIC_EnableIRQ(USART2_IRQn);//配置中断		
}

void SendByte(uint8_t dat)
{
	USART2-&gt;DR = dat;
	while((USART2-&gt;SR &amp; USART_SR_TC) == 0);
}

void Send_buffer(uint8_t *buff,uint16_t count)
{
for (int i=0;i&lt;count;i++)
	{
		SendByte(*buff);
		*buff++;
	}
}
void delay_ms(uint16_t time)     
{    
  uint16_t i=0;    
  while(time--)     
  {    
    i=12000;    
    while(i--);    
  }    
}
void USART2_IRQHandler(void)
{
	if(USART2-&gt;SR &amp; USART_SR_RXNE)
	{
		buffer[buffer_size] = USART2-&gt;DR;
		buffer_size++;
		if(buffer[buffer_size-1] == 'k')
		{
			GPIOB-&gt;ODR &amp;= ~(1 &lt;&lt;0); //LEN0 OFF
			buffer_size = 0;
			USART2-&gt;CR1 &amp;= ~USART_CR1_RE;
		}
		else if(USART2-&gt;DR == 'l')
		{
			GPIOB-&gt;ODR |= 1 &lt;&lt; 0; // LED0 ON
			buffer_size = 0;
			USART2-&gt;CR1 &amp;= ~USART_CR1_RE;
		}
	}
}
int main()
{
	clock_set();
	usart2_Init(USART_BAUDRATE);
	uint8_t s[]=&quot;k off l open &quot;;
	current_send_byte=sizeof(s);
	GPIOB-&gt;ODR=0x00000000;//gpiob all pin low
	while(1)
	{

		 if(!(GPIOB-&gt;IDR &amp; GPIO_IDR_ID9))//if gpioa_pin9 low ,enter if function
			 {
			 delay_ms(5);                //Eliminate key jitter
			 if(!(GPIOB-&gt;IDR&amp;GPIO_IDR_ID9))
					{
						Send_buffer(s,current_send_byte);
						USART2-&gt;CR1 |= USART_CR1_RE;
						GPIOB-&gt;ODR |= 1 &lt;&lt; 1; // LED1 ON
						while(!(GPIOB-&gt;IDR&amp;GPIO_IDR_ID9));//Wait for  key to rebound                                                                       
					}
			 }
 
	}
}
</code></pre>
<h2 id="simulation">Simulation</h2>
<p>The devices in proteus are built as follows</p>
<figure data-type="image" tabindex="5"><img src="https://liuxuejun123.github.io//post-images/1586768061207.PNG" alt="" loading="lazy"></figure>
<p>Start the simulation, press the button, the LED lights up, and the serial port outputs information<br>
<img src="https://liuxuejun123.github.io//post-images/1586768067660.PNG" alt="" loading="lazy"></p>
<p>Keyboard input (small letter L) LED0 is on</p>
<figure data-type="image" tabindex="6"><img src="https://liuxuejun123.github.io//post-images/1586768074621.PNG" alt="" loading="lazy"></figure>
<p>Keyboard input k LED0 is off<br>
<img src="https://liuxuejun123.github.io//post-images/1586768081298.PNG" alt="" loading="lazy"></p>
<h2 id="conclusion">Conclusion</h2>

							</div>
	<div class="wow bounceInDown vt-post-tags">
 
					</div>						
<nav class="navigation3 post-navigation3" role="navigation">
		
		<div class="nav-links3">
      
		<div class="wow bounceInLeft nav-previous3"><a href="https://liuxuejun123.github.io/post/stm32f401re-pwm-shu-chu/" rel="prev"> STM32F401RE PWM输出</a></div>
		 
		 
		<div class="wow bounceInRight nav-next3"><a href="https://liuxuejun123.github.io/post/ren-wu-yi-stm32f401re-er-jin-zhi-jia-jian-qi/" rel="next">  STM32F401RE 二进制加减器</a></div>
		
		</div>
	</nav>
	<div class="wow rollIn author-info" style="visibility: visible; animation-name: rollIn;">
	<div class="author-avatar pull-left"><img src="https://liuxuejun123.github.io//images/avatar.png" ></div>
 
	<div class="author-description"><div class="author-title"><div class="author-link" rel="author">INNovationlxj</div></div>


	<p class="author-bio">只有足够努力，才能看起来毫不费力</p></div></div>
	
		</div>
		
 
		
</article>

<div id="marlin_lite_about_widget-2" class="wow bounceInUp widget marlin_lite_about_widget" data-wow-delay="0.1s">
		
        
		<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://liuxuejun123.github.io//media/scripts/Valine.min.js'></script>

<div class="comment"></div>
<script>
        new Valine({
            // AV 对象来自上面引入av-min.js(老司机们不要开车➳♡゛扎心了老铁)
            av: AV, 
            el: '.comment',
            lang: 'zh-cn',
            
            admin_email:'liuxuejun0855@163.com',
            
            
      emoticon_list: ["吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"],
     	
      	
          
        });
    </script> 


   
  
 

		</div>

			</div>
			


<div class="tocc col l3 hide-on-med-and-down">
	
        <div class="toc-widget">
			
            <div class="toc-title"></div>
			
            <div id="toc-content">
			
			
			</div>
        </div>
    </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.5.0/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '.entry-summary',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('.entry-summary').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>										 

 
       


			</div>
		</div>

		
		 	<footer id="colophon" class="site-footer">

			<div class="container">
	
				<div class="copyright">Powered by 
<a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
<br><br>
Copyright 2020 &copy 
<a href="https://twitter.com/mei_samson" target="_blank">
<span style="color:blue">Liuxuejun</span></a>
<br><br>
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="blank"
<span style="color:orange">本博客采用 CC BY-NC-SA 4.0 进行许可</span></a><br>Theme:   <a href="https://github.com/shanbufun/gridea-theme-pan" target="_blank" title="Pan"><span>Pan</span></a>.  by <a href="https://shanbu.fun/" target="_blank"  title="山卜方" >Shanbufun</a></div>		
			</div>
		
		</footer>

</div>

<script src="https://cdn.bootcss.com/fitvids/1.2.0/jquery.fitvids.min.js"></script>
<script type='text/javascript' src='https://liuxuejun123.github.io//media/scripts/marlin-scripts.js'></script>
 <script src="//tokinx.github.io/lately/lately.min.js"></script>
  <script>jQuery(document).ready(function(){$.lately({'target':'.lately-a,.lately-b,.lately-c'})});</script>
  <style type="text/css">a.back_to_top {
    text-decoration: none;
    position: fixed;
    bottom: 40px;
    right: 30px;
    background: #f0f0f0;
    height: 40px;
    width: 40px;
    border-radius: 50%;
    line-height: 36px;
    font-size: 18px;
    text-align: center;
    transition-duration: .5s;
    transition-propety: background-color;
    display: none;
}

a.back_to_top span {
    color: #888;
}

a.back_to_top:hover {
    cursor: pointer;
    background: #dfdfdf;
}

a.back_to_top:hover span {
    color: #555;
}

@media print, screen and (max-width: 580px) {
    .back_to_top {
        display: none !important;
    }
}



</style><a id="back_to_top" href="#" class="back_to_top"><span><i class="iconfont icon-xiangshang"></i></span>
</a>


<script>$(document).ready((function(_this) {
  return function() {
    var bt;
    bt = $('#back_to_top');
    if ($(document).width() > 480) {
      $(window).scroll(function() {
        var st;
        st = $(window).scrollTop();
        if (st > 30) {
          return bt.css('display', 'block');
        } else {
          return bt.css('display', 'none');
        }
      });
      return bt.click(function() {
        $('body,html').animate({
          scrollTop: 0
        }, 800);
        return false;
      });
    }
  };
})(this));
</script>

		<script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $('.navigation:eq(0)').remove();
                $("").attr("rel" , "external");
                $("a[rel='external'],a[rel='external nofollow']").attr("target","_blank");
                $("a.vi").attr("rel" , "");
                $.viewImage({
                    'target'  : 'img',
                    'exclude' : '.vsmile-icons img,.gallery img',
                    'delay'   : 300
                });
                $.lately({
                    'target' : '.commentmetadata a,.infos time,.post-list time'
                });
                prettyPrint();
                
                $('ul.links li a').each(function(){
                    if($(this).parent().find('.bg').length==0){
                        $(this).parent().append('<!---<div class="bg" style="background-image:url(https://c3.glgoo.top/s2/favicons?domain='+$(this).attr("href")+')"></div>--->')
                    }
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>

</body>
</html>
